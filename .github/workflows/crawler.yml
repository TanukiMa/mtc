name: åšåŠ´çœã‚µã‚¤ãƒˆå°‚é–€ç”¨èªè§£æ (SudachiDict-full)

on:
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJST 11æ™‚ï¼‰ã«å®Ÿè¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      max_workers:
        description: 'ä¸¦åˆ—å‡¦ç†æ•°'
        required: false
        default: '1'  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’1ã«å‰Šæ¸›ï¼ˆLLMã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ï¼‰
        type: string

env:
  PYTHON_VERSION: '3.11'
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  analyze-mhlw-terms:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # SudachiDict-fullã‚’è€ƒæ…®ã—ã¦3æ™‚é–“ã«å»¶é•·
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install system dependencies (minimal for package installation)
      run: |
        sudo apt-get update
        # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹å¼ã®ãŸã‚ã€build toolsã¯ä¸è¦
        echo "â„¹ï¸  ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã¯æœ€å°é™ï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹å¼ï¼‰"
    
    - name: Install Python dependencies (including SudachiDict-full)
      run: |
        python -m pip install --upgrade pip
        
        echo "ğŸ“¦ Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        pip install \
          requests==2.31.0 \
          beautifulsoup4==4.12.2 \
          supabase==2.0.2 \
          sudachipy==0.6.7 \
          huggingface_hub==0.19.4 \
          python-docx==0.8.11 \
          python-pptx==0.6.22 \
          PyPDF2==3.0.1 \
          lxml==4.9.3
        
        echo "ğŸ“š Sudachiè¾æ›¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        echo "â° Fullè¾æ›¸ã¯å¤§å®¹é‡ã®ãŸã‚ã€2-3åˆ†ã‹ã‹ã‚Šã¾ã™..."
        
        # Coreè¾æ›¸ã‚‚ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
        pip install sudachidict_core
        # Fullè¾æ›¸ã‚’ãƒ¡ã‚¤ãƒ³è¾æ›¸ã¨ã—ã¦ä½¿ç”¨
        pip install SudachiDict-full
        
        echo "âœ… ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
    
name: åšåŠ´çœã‚µã‚¤ãƒˆå°‚é–€ç”¨èªè§£æ (è¾æ›¸ãƒ™ãƒ¼ã‚¹åˆ¤å®š)

on:
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJST 11æ™‚ï¼‰ã«å®Ÿè¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      max_workers:
        description: 'ä¸¦åˆ—å‡¦ç†æ•°'
        required: false
        default: '3'  # LLMä¸ä½¿ç”¨ã®ãŸã‚å…ƒã®å€¤ã«æˆ»ã™
        type: string

env:
  PYTHON_VERSION: '3.11'
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  analyze-mhlw-terms:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # LLMå‰Šé™¤ã§2æ™‚é–“ã«çŸ­ç¸®
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install system dependencies (minimal)
      run: |
        sudo apt-get update
        # LLMä¸ä½¿ç”¨ã®ãŸã‚ã•ã‚‰ã«è»½é‡åŒ–
        echo "âœ… ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã¯æœ€å°é™ï¼ˆè¾æ›¸ãƒ™ãƒ¼ã‚¹åˆ¤å®šï¼‰"
    
    - name: Install Python dependencies (SudachiDict-full only)
      run: |
        python -m pip install --upgrade pip
        
        echo "ğŸ“¦ Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        pip install \
          requests==2.31.0 \
          beautifulsoup4==4.12.2 \
          supabase==2.0.2 \
          sudachipy==0.6.7 \
          sudachidict_core \
          SudachiDict-full \
          python-docx==0.8.11 \
          python-pptx==0.6.22 \
          PyPDF2==3.0.1 \
          lxml==4.9.3
        
        echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ï¼ˆLLMé–¢é€£ãªã—ï¼‰"
        
        # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
        echo "ğŸ“š Sudachiè¾æ›¸ç¢ºèª:"
        pip list | grep -i sudachi
    
    - name: Setup and Test SudachiDict-full (dictionary-based detection)
      run: |
        echo "ğŸ”¤ SudachiDict-full è¨­å®šãƒ»å‹•ä½œç¢ºèªï¼ˆè¾æ›¸ãƒ™ãƒ¼ã‚¹åˆ¤å®šï¼‰"
        
        # SudachiPyè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆFullè¾æ›¸æŒ‡å®šï¼‰
        mkdir -p ~/.sudachi
        python -c "
        import json
        import os
        from pathlib import Path
        
        # SudachiDict-fullã®ãƒ‘ã‚¹ã‚’æ¢ã™
        try:
            import sudachidict_full
            full_dict_path = Path(sudachidict_full.__file__).parent / 'resources' / 'system.dic'
            print(f'ğŸ“ SudachiDict-full ãƒ‘ã‚¹: {full_dict_path}')
        except ImportError:
            print('âš ï¸  SudachiDict-fullãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
            full_dict_path = None
        
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        config = {
            'systemDict': str(full_dict_path) if full_dict_path and full_dict_path.exists() else None,
            'characterDefinitionFile': 'char.def',
            'inputTextPlugin': [],
            'oovProviderPlugin': [],
            'pathRewritePlugin': [],
            'connectPlugin': []
        }
        
        config_path = Path.home() / '.sudachi' / 'sudachi.json'
        with open(config_path, 'w', encoding='utf-8') as f:
            json.dump(config, f, indent=2, ensure_ascii=False)
        
        print(f'ğŸ“„ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: {config_path}')
        "
        
        # å‹•ä½œç¢ºèªã¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        python -c "
        import time
        from sudachipy import tokenizer, dictionary
        
        print('ğŸš€ SudachiDict-full åˆæœŸåŒ–ä¸­ï¼ˆè¾æ›¸ãƒ™ãƒ¼ã‚¹åˆ¤å®šï¼‰...')
        start_time = time.time()
        
        try:
            # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦è¾æ›¸åˆæœŸåŒ–
            tokenizer_obj = dictionary.Dictionary().create()
            init_time = time.time() - start_time
            print(f'â±ï¸  åˆæœŸåŒ–å®Œäº†: {init_time:.2f}ç§’')
            
            # è¾æ›¸ãƒ™ãƒ¼ã‚¹æ–°èªåˆ¤å®šãƒ†ã‚¹ãƒˆ
            test_cases = [
                ('ãƒ†ãƒ¬ãƒ¡ãƒ‡ã‚£ã‚·ãƒ³', 'æ—¢çŸ¥èªã‹æ–°èªã‹ãƒ†ã‚¹ãƒˆ'),
                ('é éš”è¨ºç™‚', 'æ—¢çŸ¥èªã‹æ–°èªã‹ãƒ†ã‚¹ãƒˆ'), 
                ('DXæ¨é€²', 'æ–°èªå€™è£œ'),
                ('åŒ»ç™‚å¾“äº‹è€…', 'æ—¢çŸ¥èª'),
                ('PHRã‚·ã‚¹ãƒ†ãƒ ', 'æ–°èªå€™è£œ')
            ]
            
            print('\\nğŸ“ è¾æ›¸ãƒ™ãƒ¼ã‚¹æ–°èªåˆ¤å®šãƒ†ã‚¹ãƒˆ:')
            print('=' * 50)
            
            for word, description in test_cases:
                start = time.time()
                tokens = tokenizer_obj.tokenize(word, tokenizer.Tokenizer.SplitMode.A)
                parse_time = time.time() - start
                
                # è¾æ›¸åè¼‰åˆ¤å®šï¼ˆç°¡æ˜“ç‰ˆï¼‰
                is_single_token = len(tokens) == 1
                token_surface = tokens[0].surface() if tokens else ''
                matches_input = token_surface == word if tokens else False
                
                status = 'æ—¢çŸ¥èªï¼ˆè¾æ›¸åè¼‰æ¸ˆã¿ï¼‰' if (is_single_token and matches_input) else 'æ–°èªå€™è£œï¼ˆè¾æ›¸æœªåè¼‰ï¼‰'
                
                print(f'  {word}: {status}')
                print(f'    è§£æçµæœ: {[t.surface() for t in tokens]}')
                print(f'    è§£ææ™‚é–“: {parse_time*1000:.1f}ms')
                print()
            
            print(f'âœ… SudachiDict-full è¾æ›¸ãƒ™ãƒ¼ã‚¹åˆ¤å®šãƒ†ã‚¹ãƒˆå®Œäº†')
            print('ğŸ¯ LLMä¸ä½¿ç”¨ã§é«˜é€Ÿãƒ»ç¢ºå®Ÿãªæ–°èªæ¤œå‡ºãŒå¯èƒ½ã§ã™')
            
        except Exception as e:
            print(f'âŒ SudachiDict-full ã‚¨ãƒ©ãƒ¼: {e}')
            raise
        "
    
    - name: Create cache directories
      run: |
        mkdir -p ~/.cache/sudachi
        mkdir -p /tmp
        echo "ğŸ“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆå®Œäº†"
    
    - name: Verify complete environment (without LLM)
      run: |
        echo "ğŸ” ç’°å¢ƒç¢ºèªãƒ»å‹•ä½œæ¤œè¨¼ï¼ˆè¾æ›¸ãƒ™ãƒ¼ã‚¹ï¼‰"
        echo "================================"
        
        echo "ğŸ Pythonç’°å¢ƒ:"
        python --version
        
        echo "ğŸ”¤ SudachiPy + Fullè¾æ›¸ æœ€çµ‚ç¢ºèª:"
        python -c "
        from sudachipy import dictionary, tokenizer
        import os
        tokenizer_obj = dictionary.Dictionary().create()
        # æ­£ã—ã„SplitModeåˆ—æŒ™å‹ã‚’ä½¿ç”¨
        tokens = tokenizer_obj.tokenize('åšåŠ´çœ', tokenizer.Tokenizer.SplitMode.A)
        print(f'âœ… SudachiDict-full æº–å‚™å®Œäº† (ãƒ†ã‚¹ãƒˆ: {len(tokens)}ãƒˆãƒ¼ã‚¯ãƒ³)')
        "
        
        echo "ğŸ—„ï¸ Supabaseæ¥ç¶šç¢ºèª:"
        echo "SUPABASE_URL: ${SUPABASE_URL:0:30}..."
        
        echo "ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ³:"
        # SudachiDictç¢ºèª
        echo "ğŸ“š Sudachiè¾æ›¸ç¢ºèª:"
        pip list | grep -i sudachi
        
        echo "âœ… ç’°å¢ƒæ¤œè¨¼å®Œäº† - è¾æ›¸ãƒ™ãƒ¼ã‚¹åˆ¤å®šæº–å‚™å®Œäº†"
        echo "ğŸ’¡ LLMã¯ä½¿ç”¨ã›ãšã€SudachiDict-fullï¼ˆ170ä¸‡èªï¼‰ã¨ã®ç…§åˆã§æ–°èªæ¤œå‡º"
    
    - name: Initialize Supabase dictionary (service_role key)
      run: |
        echo "ğŸ—„ï¸ Supabase åŸºæœ¬è¾æ›¸åˆæœŸåŒ–ï¼ˆservice_role keyä½¿ç”¨ï¼‰"
        
        python3 << 'EOF'
        import os
        from supabase import create_client
        
        print("ğŸ“¡ Supabaseæ¥ç¶šä¸­ï¼ˆservice_role keyä½¿ç”¨ï¼‰...")
        
        # service_role keyã§æ¥ç¶šï¼ˆRLSç„¡è¦–ï¼‰
        client = create_client(
            os.environ['SUPABASE_URL'], 
            os.environ['SUPABASE_KEY']
        )
        
        # åŸºæœ¬è¾æ›¸ãƒ‡ãƒ¼ã‚¿
        basic_words = [
            {'word': 'åŒ»ç™‚', 'reading': 'ã‚¤ãƒªãƒ§ã‚¦', 'part_of_speech': 'åè©', 'source': 'basic'},
            {'word': 'åšç”ŸåŠ´åƒçœ', 'reading': 'ã‚³ã‚¦ã‚»ã‚¤ãƒ­ã‚¦ãƒ‰ã‚¦ã‚·ãƒ§ã‚¦', 'part_of_speech': 'åè©', 'source': 'basic'},
            {'word': 'å¥åº·', 'reading': 'ã‚±ãƒ³ã‚³ã‚¦', 'part_of_speech': 'åè©', 'source': 'basic'},
            {'word': 'è¨ºç™‚', 'reading': 'ã‚·ãƒ³ãƒªãƒ§ã‚¦', 'part_of_speech': 'åè©', 'source': 'basic'},
            {'word': 'è–¬äº‹', 'reading': 'ãƒ¤ã‚¯ã‚¸', 'part_of_speech': 'åè©', 'source': 'basic'},
            {'word': 'ä¿é™º', 'reading': 'ãƒ›ã‚±ãƒ³', 'part_of_speech': 'åè©', 'source': 'basic'},
            {'word': 'ä»‹è­·', 'reading': 'ã‚«ã‚¤ã‚´', 'part_of_speech': 'åè©', 'source': 'basic'},
            {'word': 'ç¦ç¥‰', 'reading': 'ãƒ•ã‚¯ã‚·', 'part_of_speech': 'åè©', 'source': 'basic'}
        ]
        
        try:
            # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç¢ºèª
            existing_count = client.table('dictionary_words').select('id', count='exact').execute()
            print(f"ğŸ“Š æ—¢å­˜è¾æ›¸èªå½™æ•°: {existing_count.count}èª")
            
            if existing_count.count == 0:
                print("ğŸ“ åŸºæœ¬è¾æ›¸åˆæœŸåŒ–ä¸­...")
                result = client.table('dictionary_words').insert(basic_words).execute()
                print(f"âœ… åŸºæœ¬è¾æ›¸ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ ({len(result.data)}èª)")
            else:
                print("â„¹ï¸  è¾æ›¸ã¯æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã§ã™")
            
            # æœ€çµ‚çµ±è¨ˆ
            final_count = client.table('dictionary_words').select('id', count='exact').execute()
            print(f"ğŸ“š ç¾åœ¨ã®è¾æ›¸èªå½™æ•°: {final_count.count}èª")
            
        except Exception as e:
            print(f"âŒ Supabaseæ“ä½œã‚¨ãƒ©ãƒ¼: {e}")
            # service_role keyãªã‚‰æ¨©é™å•é¡Œã¯ç™ºç”Ÿã—ãªã„ã¯ãš
            raise e
            
        print("âœ… Supabaseè¾æ›¸åˆæœŸåŒ–å®Œäº†")
        EOF
    
    - name: Run MHLW crawler (dictionary-based detection)
      env:
        MAX_WORKERS: ${{ github.event.inputs.max_workers || '3' }}
      run: |
        echo "ğŸš€ åšåŠ´çœã‚µã‚¤ãƒˆè§£æã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œé–‹å§‹"
        echo "====================================="
        echo "è¨­å®š:"
        echo "  - ä¸¦åˆ—å‡¦ç†æ•°: $MAX_WORKERS"
        echo "  - è¾æ›¸: SudachiDict-full (170ä¸‡èª)"
        echo "  - æ–°èªåˆ¤å®š: è¾æ›¸ãƒ™ãƒ¼ã‚¹ï¼ˆLLMä¸ä½¿ç”¨ï¼‰"
        echo "  - å¯¾è±¡: åšåŠ´çœã‚µã‚¤ãƒˆï¼ˆHTML, PDF, DOCX, PPTXï¼‰"
        echo ""
        
        # Pythonãƒ‘ã‚¹ç¢ºèª
        echo "ğŸ Pythonç’°å¢ƒç¢ºèª:"
        python --version
        which python
        echo "PYTHONPATH: ${PYTHONPATH:-æœªè¨­å®š}"
        
        # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
        if [ -f "main_crawler.py" ]; then
            echo "âœ… main_crawler.py å­˜åœ¨"
            echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -c < main_crawler.py) bytes"
            echo "ğŸ“„ å…ˆé ­5è¡Œ:"
            head -5 main_crawler.py
        else
            echo "âŒ main_crawler.py ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ğŸ“‚ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:"
            ls -la
            echo "âŒ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œã‚’åœæ­¢ã—ã¾ã™"
            exit 1
        fi
        
        echo ""
        echo "ğŸ¯ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œé–‹å§‹..."
        echo "======================"
        
        python3 << 'EOF'
        import sys
        import os
        import traceback
        from datetime import datetime
        import importlib.util
        
        print(f"ğŸ•’ å®Ÿè¡Œé–‹å§‹æ™‚åˆ»: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"ğŸ”§ Pythonç‰ˆ: {sys.version}")
        print(f"ğŸ“‚ ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {os.getcwd()}")
        print(f"ğŸ›£ï¸  Python Path: {sys.path[:3]}...")
        
        # main_crawler.pyã®å­˜åœ¨ç¢ºèª
        crawler_path = os.path.join(os.getcwd(), 'main_crawler.py')
        if not os.path.exists(crawler_path):
            print(f"âŒ {crawler_path} ãŒå­˜åœ¨ã—ã¾ã›ã‚“")
            print("ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:")
            for item in os.listdir('.'):
                print(f"  - {item}")
            sys.exit(1)
        
        # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºèª
        try:
            print("ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ...")
            
            # ä¸»è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºèª
            import requests
            print(f"  âœ… requests: {requests.__version__}")
            
            from sudachipy import tokenizer, dictionary
            print("  âœ… sudachipy: ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ")
            
            from supabase import create_client
            print("  âœ… supabase: ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ")
            
            print("ğŸ“¦ å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ãŒåˆ©ç”¨å¯èƒ½ã§ã™")
            
        except ImportError as e:
            print(f"âŒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
            sys.exit(1)
        
        # ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨å®Ÿè¡Œ
        try:
            print("ğŸ”„ main_crawler ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...")
            
            # sys.pathã«ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ 
            if os.getcwd() not in sys.path:
                sys.path.insert(0, os.getcwd())
            
            # ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
            from main_crawler import MhlwCrawler
            print("âœ… MhlwCrawler ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ")
            
            # ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
            print("ğŸ”§ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆä¸­...")
            crawler = MhlwCrawler()
            print("âœ… ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸï¼ˆè¾æ›¸ãƒ™ãƒ¼ã‚¹åˆ¤å®šï¼‰")
            
            # å®Ÿè¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            max_workers = int(os.environ.get('MAX_WORKERS', '3'))
            print(f"ğŸ‘¥ ä¸¦åˆ—å‡¦ç†æ•°: {max_workers}")
            
            # *** ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ ***
            print("ğŸš€ ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒ»è§£æé–‹å§‹...")
            print("-" * 40)
            
            crawler.run(max_workers=max_workers)
            
            print("-" * 40)
            print(f"ğŸ•’ å®Ÿè¡Œå®Œäº†æ™‚åˆ»: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            print("âœ… åšåŠ´çœã‚µã‚¤ãƒˆè§£æå®Œäº†ï¼ˆè¾æ›¸ãƒ™ãƒ¼ã‚¹æ–°èªæ¤œå‡ºï¼‰")
            
        except Exception as e:
            print(f"âŒ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
            print("ğŸ” è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±:")
            traceback.print_exc()
            
            # ã‚¨ãƒ©ãƒ¼è¨ºæ–­
            error_str = str(e)
            if "ModuleNotFoundError" in error_str:
                print("ğŸ’¡ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸è¶³ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
            elif "Permission" in error_str:
                print("ğŸ’¡ æ¨©é™å•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
            elif "Connection" in error_str:
                print("ğŸ’¡ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šå•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
            
            sys.exit(1)
        EOF
        
        echo ""
        echo "ğŸ‰ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—å®Œäº†"
    
    - name: Generate detailed analysis report (dictionary-based)
      if: always()
      run: |
        echo "ğŸ“Š è§£æçµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ï¼ˆè¾æ›¸ãƒ™ãƒ¼ã‚¹åˆ¤å®šï¼‰..."
        
        python3 << 'EOF'
        import os
        from supabase import create_client
        from datetime import datetime, timedelta
        
        client = create_client(os.environ['SUPABASE_URL'], os.environ['SUPABASE_KEY'])
        
        # ä»Šæ—¥ã®çµæœã‚µãƒãƒªãƒ¼
        today = datetime.now().date()
        
        print("ğŸ“ˆ åšåŠ´çœã‚µã‚¤ãƒˆå°‚é–€ç”¨èªè§£æçµæœ")
        print("=" * 50)
        print(f"ğŸ•’ å®Ÿè¡Œæ—¥æ™‚: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"ğŸ”¤ ä½¿ç”¨è¾æ›¸: SudachiDict-full (170ä¸‡èª)")
        print(f"ğŸ§  åˆ¤å®šæ–¹å¼: è¾æ›¸ãƒ™ãƒ¼ã‚¹ï¼ˆLLMä¸ä½¿ç”¨ï¼‰")
        print("")
        
        # æ–°èªå€™è£œæ•°
        try:
            new_words = client.table('new_word_candidates')\
                .select('*')\
                .gte('created_at', today.isoformat())\
                .execute()
            
            # å‡¦ç†URLæ•°
            processed = client.table('processed_urls')\
                .select('*')\
                .gte('created_at', today.isoformat())\
                .execute()
            
            # æŠ½å‡ºã•ã‚ŒãŸå…¨å˜èªæ•°
            extracted = client.table('extracted_words')\
                .select('*')\
                .gte('first_found', today.isoformat())\
                .execute()
            
            print(f"ğŸ“„ å‡¦ç†æ¸ˆURL: {len(processed.data)}ä»¶")
            print(f"ğŸ”¤ æŠ½å‡ºå˜èª: {len(extracted.data)}èª")
            print(f"ğŸ†• æ–°èªå€™è£œ: {len(new_words.data)}èª")
            
            if new_words.data:
                print(f"ğŸ“Š æ–°èªç™ºè¦‹ç‡: {len(new_words.data)/max(len(extracted.data),1)*100:.1f}%")
                
                print("\\nğŸ” ç™ºè¦‹ã•ã‚ŒãŸæ–°èªå€™è£œ TOP 15:")
                print("-" * 50)
                
                # ä¿¡é ¼åº¦ã§ã‚½ãƒ¼ãƒˆ
                sorted_words = sorted(new_words.data, 
                                    key=lambda x: x.get('confidence_score', 0), 
                                    reverse=True)
                
                for i, word in enumerate(sorted_words[:15], 1):
                    word_text = word.get('word', 'N/A')
                    reading = word.get('reading', 'ä¸æ˜')
                    confidence = word.get('confidence_score', 0)
                    pos = word.get('part_of_speech', 'ä¸æ˜')
                    reasoning = word.get('llm_reasoning', 'åˆ¤å®šç†ç”±ä¸æ˜')[:60]
                    
                    print(f"{i:2d}. {word_text} ({reading})")
                    print(f"    å“è©: {pos} | ä¿¡é ¼åº¦: {confidence:.3f}")
                    print(f"    åˆ¤å®š: {reasoning}...")
                    print()
            else:
                print("â„¹ï¸  ä»Šå›ã®å®Ÿè¡Œã§ã¯æ–°èªå€™è£œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
            
            # è¾æ›¸çµ±è¨ˆ
            total_dict = client.table('dictionary_words').select('id', count='exact').execute()
            print(f"ğŸ“š SupabaseåŸºæœ¬è¾æ›¸èªå½™æ•°: {total_dict.count:,}èª")
            print(f"ğŸ“– SudachiDict-full: ç´„170ä¸‡èª")
            print(f"ğŸ¯ æ–°èªåˆ¤å®š: ä¸¡è¾æ›¸ã«æœªåè¼‰ã®åè©ï¼ˆ3æ–‡å­—ä»¥ä¸Šï¼‰")
            
        except Exception as e:
            print(f"âš ï¸  ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            import traceback
            traceback.print_exc()
        
        print("\\nâœ… è§£æå®Œäº†")
        print("ğŸ¯ SudachiDict-fullã«ã‚ˆã‚‹è¾æ›¸ãƒ™ãƒ¼ã‚¹é«˜é€Ÿæ–°èªæ¤œå‡ºãŒå®Œäº†ã—ã¾ã—ãŸ")
        print("âš¡ LLMä¸ä½¿ç”¨ã«ã‚ˆã‚Šã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç„¡ã—ãƒ»é«˜é€Ÿå‡¦ç†ã‚’å®Ÿç¾")
        EOF
    
    - name: Cleanup and optimize storage
      if: always()
      run: |
        echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œä¸­..."
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        rm -rf /tmp/*.pdf /tmp/*.docx /tmp/*.pptx /tmp/*.txt
        
        # pip ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆå®¹é‡ç¯€ç´„ï¼‰
        pip cache purge
        
        # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèª
        echo "ğŸ’½ ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡:"
        df -h | head -2
        
        echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
    
    - name: Upload comprehensive logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: mhlw-crawler-logs-${{ github.run_id }}
        path: |
          *.log
          /tmp/crawler_*.txt
          /tmp/sudachi_*.log
          /var/log/syslog
        retention-days: 14
        if-no-files-found: ignore
    
    - name: Setup and Test SudachiDict-full
      run: |
        echo "ğŸ”¤ SudachiDict-full è¨­å®šãƒ»å‹•ä½œç¢ºèªãƒ»ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        
        # SudachiPyè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆFullè¾æ›¸æŒ‡å®šï¼‰
        mkdir -p ~/.sudachi
        python -c "
        import json
        import os
        from pathlib import Path
        
        # SudachiDict-fullã®ãƒ‘ã‚¹ã‚’æ¢ã™
        try:
            import sudachidict_full
            full_dict_path = Path(sudachidict_full.__file__).parent / 'resources' / 'system.dic'
            print(f'ğŸ“ SudachiDict-full ãƒ‘ã‚¹: {full_dict_path}')
        except ImportError:
            print('âš ï¸  SudachiDict-fullãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
            full_dict_path = None
        
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        config = {
            'systemDict': str(full_dict_path) if full_dict_path and full_dict_path.exists() else None,
            'characterDefinitionFile': 'char.def',
            'inputTextPlugin': [],
            'oovProviderPlugin': [],
            'pathRewritePlugin': [],
            'connectPlugin': []
        }
        
        config_path = Path.home() / '.sudachi' / 'sudachi.json'
        with open(config_path, 'w', encoding='utf-8') as f:
            json.dump(config, f, indent=2, ensure_ascii=False)
        
        print(f'ğŸ“„ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: {config_path}')
        "
        
        # å‹•ä½œç¢ºèªã¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        python -c "
        import time
        from sudachipy import tokenizer, dictionary
        
        print('ğŸš€ SudachiDict-full åˆæœŸåŒ–ä¸­...')
        start_time = time.time()
        
        try:
            # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦è¾æ›¸åˆæœŸåŒ–
            tokenizer_obj = dictionary.Dictionary().create()
            init_time = time.time() - start_time
            print(f'â±ï¸  åˆæœŸåŒ–å®Œäº†: {init_time:.2f}ç§’')
            
            # åšåŠ´çœãƒ»åŒ»ç™‚é–¢é€£ã®å°‚é–€ç”¨èªã§ãƒ†ã‚¹ãƒˆ
            test_cases = [
                'åšç”ŸåŠ´åƒçœã®æ–°ã—ã„æ–½ç­–ã«ã¤ã„ã¦',
                'ãƒ†ãƒ¬ãƒ¡ãƒ‡ã‚£ã‚·ãƒ³ã«ã‚ˆã‚‹é éš”è¨ºç™‚',
                'ãƒ¬ã‚»ãƒ—ãƒˆé›»ç®—å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ',
                'è¨ºç™‚å ±é…¬ç‚¹æ•°è¡¨ã®æ”¹å®š',
                'åŒ»ç™‚DXæ¨é€²æœ¬éƒ¨',
                'PHRï¼ˆPersonal Health Recordï¼‰',
                'åœ°åŸŸåŒ…æ‹¬ã‚±ã‚¢ã‚·ã‚¹ãƒ†ãƒ ',
                'è–¬äº‹ãƒ»é£Ÿå“è¡›ç”Ÿå¯©è­°ä¼š'
            ]
            
            print('\\nğŸ“ å°‚é–€ç”¨èªè§£æãƒ†ã‚¹ãƒˆçµæœ:')
            print('=' * 50)
            
            total_tokens = 0
            for i, text in enumerate(test_cases, 1):
                start = time.time()
                tokens = tokenizer_obj.tokenize(text, tokenizer.Tokenizer.SplitMode.A)
                parse_time = time.time() - start
                total_tokens += len(tokens)
                
                print(f'\\n{i}. ã€Œ{text}ã€')
                print(f'   è§£ææ™‚é–“: {parse_time*1000:.1f}ms | ãƒˆãƒ¼ã‚¯ãƒ³æ•°: {len(tokens)}')
                print('   å½¢æ…‹ç´ è§£æçµæœ:')
                
                for token in tokens:
                    surface = token.surface()
                    reading = token.reading_form() or 'ãƒ¼ãƒ¼'
                    pos = token.part_of_speech()[0]
                    
                    # å°‚é–€ç”¨èªã‚‰ã—ã„ã‚‚ã®ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    if pos == 'åè©' and len(surface) >= 3:
                        print(f'   ğŸ” {surface} ({reading}) [{pos}] â† å°‚é–€ç”¨èªå€™è£œ')
                    else:
                        print(f'     {surface} ({reading}) [{pos}]')
            
            print(f'\\nâœ… SudachiDict-full ãƒ†ã‚¹ãƒˆå®Œäº†')
            print(f'ğŸ“Š ç·è§£æ: {len(test_cases)}æ–‡ / {total_tokens}ãƒˆãƒ¼ã‚¯ãƒ³')
            print('ğŸ¯ å°‚é–€ç”¨èªã®è©³ç´°ãªåˆ†å‰²ãƒ»èª­ã¿å–ã‚ŠãŒç¢ºèªã§ãã¾ã—ãŸ')
            
        except Exception as e:
            print(f'âŒ SudachiDict-full åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}')
            print('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¾æ›¸ã‚’ä½¿ç”¨ã—ã¾ã™')
            
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
            tokenizer_obj = dictionary.Dictionary().create()
            tokens = tokenizer_obj.tokenize('åšç”ŸåŠ´åƒçœ', tokenizer.Tokenizer.SplitMode.A)
            print(f'âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¾æ›¸ã§å‹•ä½œç¢ºèªå®Œäº† ({len(tokens)}ãƒˆãƒ¼ã‚¯ãƒ³)')
        "
        
        echo "ğŸ“š ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿è¾æ›¸ç¢ºèª:"
        pip list | grep -i sudachi
    
    - name: Create cache directories
      run: |
        mkdir -p ~/.cache/sudachi
        mkdir -p /tmp
        echo "ğŸ“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆå®Œäº†"
    
    - name: Verify complete environment
      run: |
        echo "ğŸ” ç’°å¢ƒç¢ºèªãƒ»å‹•ä½œæ¤œè¨¼"
        echo "=========================="
        
        echo "ğŸ Pythonç’°å¢ƒ:"
        python --version
        
        echo "ğŸ¤– llama-cliç¢ºèª:"
        if command -v llama-cli >/dev/null 2>&1; then
            echo "âœ… llama-cli found in PATH"
            llama-cli --version 2>/dev/null || llama-cli --help | head -3
        elif [ -f "/usr/local/bin/llama-cli" ]; then
            echo "âœ… llama-cli found at /usr/local/bin/llama-cli (source build)"
            /usr/local/bin/llama-cli --version 2>/dev/null || /usr/local/bin/llama-cli --help | head -3
        else
            echo "âŒ llama-cli not found"
            exit 1
        fi
        
        echo "ğŸ”¤ SudachiPy + Fullè¾æ›¸ æœ€çµ‚ç¢ºèª:"
        python -c "
        from sudachipy import dictionary, tokenizer
        import os
        tokenizer_obj = dictionary.Dictionary().create()
        # æ­£ã—ã„SplitModeåˆ—æŒ™å‹ã‚’ä½¿ç”¨
        tokens = tokenizer_obj.tokenize('åšåŠ´çœ', tokenizer.Tokenizer.SplitMode.A)
        print(f'âœ… SudachiDict-full æº–å‚™å®Œäº† (ãƒ†ã‚¹ãƒˆ: {len(tokens)}ãƒˆãƒ¼ã‚¯ãƒ³)')
        "
        
        echo "ğŸ—„ï¸ Supabaseæ¥ç¶šç¢ºèª:"
        echo "SUPABASE_URL: ${SUPABASE_URL:0:30}..."
        
        echo "ğŸ¤– LLMãƒ¢ãƒ‡ãƒ«ç¢ºèª:"
        echo "Model path: $LLAMA_MODEL_PATH"
        echo "CLI path: $LLAMA_CLI_PATH"
        if [ -f "$LLAMA_MODEL_PATH" ]; then
            file "$LLAMA_MODEL_PATH"
        else
            echo "âŒ Model file not found: $LLAMA_MODEL_PATH"
        fi
        
        echo "ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ³:"
        # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç‰ˆã®ç¢ºèª
        if dpkg -l | grep -q llama; then
            echo "âœ… llama.cpp package installed:"
            dpkg -l | grep llama
        else
            echo "â„¹ï¸  llama.cpp installed via source build"
        fi
        
        # SudachiDictç¢ºèª
        echo "ğŸ“š Sudachiè¾æ›¸ç¢ºèª:"
        pip list | grep -i sudachi
        
        echo "âœ… ç’°å¢ƒæ¤œè¨¼å®Œäº† - ã™ã¹ã¦æ­£å¸¸"
    
    - name: Initialize Supabase dictionary (basic words)
      run: |
        echo "ğŸ—„ï¸ Supabase åŸºæœ¬è¾æ›¸åˆæœŸåŒ–"
        
        python3 << 'EOF'
        import os
        from supabase import create_client
        
        print("ğŸ“¡ Supabaseæ¥ç¶šä¸­...")
        
        # ç’°å¢ƒå¤‰æ•°ç¢ºèª
        supabase_url = os.environ.get('SUPABASE_URL')
        supabase_key = os.environ.get('SUPABASE_KEY')
        
        if not supabase_url or not supabase_key:
            print("âŒ Supabaseèªè¨¼æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™")
            exit(1)
        
        print(f"ğŸ”‘ ä½¿ç”¨ä¸­ã®ã‚­ãƒ¼: {'service_role' if len(supabase_key) > 100 else 'anon'}ã‚¿ã‚¤ãƒ—")
        
        try:
            client = create_client(supabase_url, supabase_key)
            
            # æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆèª­ã¿å–ã‚Šï¼‰
            print("ğŸ“– æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...")
            test_read = client.table('dictionary_words').select('id').limit(1).execute()
            print(f"âœ… èª­ã¿å–ã‚ŠæˆåŠŸ: {len(test_read.data)}ä»¶")
            
            # åšåŠ´çœãƒ»åŒ»ç™‚åˆ†é‡ã®åŸºæœ¬è¾æ›¸èªå½™
            basic_words = [
                {'word': 'åŒ»ç™‚', 'reading': 'ã‚¤ãƒªãƒ§ã‚¦', 'part_of_speech': 'åè©', 'source': 'basic'},
                {'word': 'åšç”ŸåŠ´åƒçœ', 'reading': 'ã‚³ã‚¦ã‚»ã‚¤ãƒ­ã‚¦ãƒ‰ã‚¦ã‚·ãƒ§ã‚¦', 'part_of_speech': 'åè©', 'source': 'basic'},
                {'word': 'å¥åº·', 'reading': 'ã‚±ãƒ³ã‚³ã‚¦', 'part_of_speech': 'åè©', 'source': 'basic'},
                {'word': 'è¨ºç™‚', 'reading': 'ã‚·ãƒ³ãƒªãƒ§ã‚¦', 'part_of_speech': 'åè©', 'source': 'basic'},
                {'word': 'è–¬äº‹', 'reading': 'ãƒ¤ã‚¯ã‚¸', 'part_of_speech': 'åè©', 'source': 'basic'},
                {'word': 'ä¿é™º', 'reading': 'ãƒ›ã‚±ãƒ³', 'part_of_speech': 'åè©', 'source': 'basic'},
                {'word': 'ä»‹è­·', 'reading': 'ã‚«ã‚¤ã‚´', 'part_of_speech': 'åè©', 'source': 'basic'},
                {'word': 'ç¦ç¥‰', 'reading': 'ãƒ•ã‚¯ã‚·', 'part_of_speech': 'åè©', 'source': 'basic'}
            ]
            
            # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç¢ºèª
            existing_count = client.table('dictionary_words').select('id', count='exact').execute()
            print(f"ğŸ“Š æ—¢å­˜è¾æ›¸èªå½™æ•°: {existing_count.count}èª")
            
            if existing_count.count == 0:
                print("ğŸ“ åŸºæœ¬è¾æ›¸åˆæœŸåŒ–ä¸­...")
                
                # RLSã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼šä¸€ã¤ãšã¤æŒ¿å…¥ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                successful_inserts = 0
                for word_data in basic_words:
                    try:
                        result = client.table('dictionary_words').insert(word_data).execute()
                        if result.data:
                            successful_inserts += 1
                    except Exception as word_error:
                        print(f"âš ï¸  å˜èªæŒ¿å…¥å¤±æ•— '{word_data['word']}': {word_error}")
                
                if successful_inserts > 0:
                    print(f"âœ… åŸºæœ¬è¾æ›¸ã‚’éƒ¨åˆ†çš„ã«åˆæœŸåŒ–ã—ã¾ã—ãŸ ({successful_inserts}/{len(basic_words)}èª)")
                else:
                    print("âš ï¸  åŸºæœ¬è¾æ›¸ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆRLSãƒãƒªã‚·ãƒ¼å•é¡Œã®å¯èƒ½æ€§ï¼‰")
                    print("ğŸ’¡ ãƒ’ãƒ³ãƒˆ: service_roleã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™")
            else:
                print("â„¹ï¸  è¾æ›¸ã¯æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã§ã™")
            
            # æœ€çµ‚çµ±è¨ˆ
            final_count = client.table('dictionary_words').select('id', count='exact').execute()
            print(f"ğŸ“š ç¾åœ¨ã®è¾æ›¸èªå½™æ•°: {final_count.count}èª")
            
        except Exception as e:
            error_msg = str(e)
            print(f"âŒ Supabaseæ“ä½œã‚¨ãƒ©ãƒ¼: {error_msg}")
            
            # RLSã‚¨ãƒ©ãƒ¼ã®è¨ºæ–­
            if "row-level security policy" in error_msg:
                print("ğŸ”’ RLS (Row Level Security) ãƒãƒªã‚·ãƒ¼ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ")
                print("ğŸ”§ è§£æ±ºæ–¹æ³•:")
                print("  1. GitHub Secretsã§SUPABASE_KEYã‚’service_roleã‚­ãƒ¼ã«å¤‰æ›´")
                print("  2. ã¾ãŸã¯ Supabaseã§é©åˆ‡ãªRLSãƒãƒªã‚·ãƒ¼ã‚’è¨­å®š")
                print("  3. è©³ç´°: https://supabase.com/docs/guides/auth/row-level-security")
            
            # ã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†ç¶™ç¶šï¼ˆè¾æ›¸ãªã—ã§ã‚‚å‹•ä½œå¯èƒ½ï¼‰
            print("âš ï¸  è¾æ›¸åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™")
            
        print("âœ… Supabaseè¾æ›¸åˆæœŸåŒ–ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†")
        EOF
    
    - name: Run MHLW crawler (with enhanced debugging)
      env:
        MAX_WORKERS: ${{ github.event.inputs.max_workers || '1' }}  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1ã«å‰Šæ¸›
      run: |
        echo "ğŸš€ åšåŠ´çœã‚µã‚¤ãƒˆè§£æã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œé–‹å§‹"
        echo "====================================="
        echo "è¨­å®š:"
        echo "  - ä¸¦åˆ—å‡¦ç†æ•°: $MAX_WORKERSï¼ˆLLMã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ã§å‰Šæ¸›ï¼‰"
        echo "  - è¾æ›¸: SudachiDict-full (170ä¸‡èª)"
        echo "  - å¯¾è±¡: åšåŠ´çœã‚µã‚¤ãƒˆï¼ˆHTML, PDF, DOCX, PPTXï¼‰"
        echo "  - LLMãƒ¢ãƒ‡ãƒ«: $LLAMA_MODEL_PATH"
        echo "  - Supabase: ${SUPABASE_URL:0:30}..."
        echo ""
        
        # Pythonãƒ‘ã‚¹ç¢ºèª
        echo "ğŸ Pythonç’°å¢ƒç¢ºèª:"
        python --version
        which python
        echo "PYTHONPATH: ${PYTHONPATH:-æœªè¨­å®š}"
        
        # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
        if [ -f "main_crawler.py" ]; then
            echo "âœ… main_crawler.py å­˜åœ¨"
            echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -c < main_crawler.py) bytes"
            echo "ğŸ“„ å…ˆé ­5è¡Œ:"
            head -5 main_crawler.py
        else
            echo "âŒ main_crawler.py ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ğŸ“‚ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:"
            ls -la
            echo "âŒ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œã‚’åœæ­¢ã—ã¾ã™"
            exit 1
        fi
        
        echo ""
        echo "ğŸ¯ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œé–‹å§‹..."
        echo "======================"
        
        python3 << 'EOF'
        import sys
        import os
        import traceback
        from datetime import datetime
        import importlib.util
        
        print(f"ğŸ•’ å®Ÿè¡Œé–‹å§‹æ™‚åˆ»: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"ğŸ”§ Pythonç‰ˆ: {sys.version}")
        print(f"ğŸ“‚ ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {os.getcwd()}")
        print(f"ğŸ›£ï¸  Python Path: {sys.path[:3]}...")
        
        # main_crawler.pyã®å­˜åœ¨ç¢ºèª
        crawler_path = os.path.join(os.getcwd(), 'main_crawler.py')
        if not os.path.exists(crawler_path):
            print(f"âŒ {crawler_path} ãŒå­˜åœ¨ã—ã¾ã›ã‚“")
            print("ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:")
            for item in os.listdir('.'):
                print(f"  - {item}")
            sys.exit(1)
        
        # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºèª
        try:
            print("ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ...")
            
            # ä¸»è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºèª
            import requests
            print(f"  âœ… requests: {requests.__version__}")
            
            from sudachipy import tokenizer, dictionary
            print("  âœ… sudachipy: ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ")
            
            from supabase import create_client
            print("  âœ… supabase: ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ")
            
            print("ğŸ“¦ å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ãŒåˆ©ç”¨å¯èƒ½ã§ã™")
            
        except ImportError as e:
            print(f"âŒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
            sys.exit(1)
        
        # ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨å®Ÿè¡Œ
        try:
            print("ğŸ”„ main_crawler ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...")
            
            # sys.pathã«ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ 
            if os.getcwd() not in sys.path:
                sys.path.insert(0, os.getcwd())
            
            # ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
            from main_crawler import MhlwCrawler
            print("âœ… MhlwCrawler ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ")
            
            # ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
            print("ğŸ”§ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆä¸­...")
            crawler = MhlwCrawler()
            print("âœ… ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ")
            
            # å®Ÿè¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            max_workers = int(os.environ.get('MAX_WORKERS', '3'))
            print(f"ğŸ‘¥ ä¸¦åˆ—å‡¦ç†æ•°: {max_workers}")
            
            # *** ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ ***
            print("ğŸš€ ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒ»è§£æé–‹å§‹...")
            print("-" * 40)
            
            crawler.run(max_workers=max_workers)
            
            print("-" * 40)
            print(f"ğŸ•’ å®Ÿè¡Œå®Œäº†æ™‚åˆ»: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            print("âœ… åšåŠ´çœã‚µã‚¤ãƒˆè§£æå®Œäº†")
            
        except Exception as e:
            print(f"âŒ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
            print("ğŸ” è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±:")
            traceback.print_exc()
            
            # ã‚¨ãƒ©ãƒ¼è¨ºæ–­
            error_str = str(e)
            if "ModuleNotFoundError" in error_str:
                print("ğŸ’¡ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸è¶³ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
            elif "Permission" in error_str:
                print("ğŸ’¡ æ¨©é™å•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
            elif "Connection" in error_str:
                print("ğŸ’¡ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šå•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
            
            sys.exit(1)
        EOF
        
        echo ""
        echo "ğŸ‰ ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—å®Œäº†"
    
    - name: Generate detailed analysis report
      if: always()
      run: |
        echo "ğŸ“Š è§£æçµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
        
        python3 << 'EOF'
        import os
        from supabase import create_client
        from datetime import datetime, timedelta
        
        client = create_client(os.environ['SUPABASE_URL'], os.environ['SUPABASE_KEY'])
        
        # ä»Šæ—¥ã®çµæœã‚µãƒãƒªãƒ¼
        today = datetime.now().date()
        
        print("ğŸ“ˆ åšåŠ´çœã‚µã‚¤ãƒˆå°‚é–€ç”¨èªè§£æçµæœ")
        print("=" * 50)
        print(f"ğŸ•’ å®Ÿè¡Œæ—¥æ™‚: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"ğŸ”¤ ä½¿ç”¨è¾æ›¸: SudachiDict-full (170ä¸‡èª)")
        print("")
        
        # æ–°èªå€™è£œæ•°
        try:
            new_words = client.table('new_word_candidates')\
                .select('*')\
                .gte('created_at', today.isoformat())\
                .execute()
            
            # å‡¦ç†URLæ•°
            processed = client.table('processed_urls')\
                .select('*')\
                .gte('created_at', today.isoformat())\
                .execute()
            
            # æŠ½å‡ºã•ã‚ŒãŸå…¨å˜èªæ•°
            extracted = client.table('extracted_words')\
                .select('*')\
                .gte('first_found', today.isoformat())\
                .execute()
            
            print(f"ğŸ“„ å‡¦ç†æ¸ˆURL: {len(processed.data)}ä»¶")
            print(f"ğŸ”¤ æŠ½å‡ºå˜èª: {len(extracted.data)}èª")
            print(f"ğŸ†• æ–°èªå€™è£œ: {len(new_words.data)}èª")
            
            if new_words.data:
                print(f"ğŸ“Š æ–°èªç™ºè¦‹ç‡: {len(new_words.data)/max(len(extracted.data),1)*100:.1f}%")
                
                print("\\nğŸ” ç™ºè¦‹ã•ã‚ŒãŸæ–°èªå€™è£œ TOP 10:")
                print("-" * 40)
                
                # ä¿¡é ¼åº¦ã§ã‚½ãƒ¼ãƒˆ
                sorted_words = sorted(new_words.data, 
                                    key=lambda x: x.get('confidence_score', 0), 
                                    reverse=True)
                
                for i, word in enumerate(sorted_words[:10], 1):
                    word_text = word.get('word', 'N/A')
                    reading = word.get('reading', 'ä¸æ˜')
                    confidence = word.get('confidence_score', 0)
                    pos = word.get('part_of_speech', 'ä¸æ˜')
                    reasoning = word.get('llm_reasoning', 'ç†ç”±ä¸æ˜')[:50]
                    
                    print(f"{i:2d}. {word_text} ({reading})")
                    print(f"    å“è©: {pos} | ä¿¡é ¼åº¦: {confidence:.3f}")
                    print(f"    ç†ç”±: {reasoning}...")
                    print()
            else:
                print("â„¹ï¸  ä»Šå›ã®å®Ÿè¡Œã§ã¯æ–°èªå€™è£œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
            
            # è¾æ›¸çµ±è¨ˆ
            total_dict = client.table('dictionary_words').select('id', count='exact').execute()
            print(f"ğŸ“š ç¾åœ¨ã®è¾æ›¸èªå½™æ•°: {total_dict.count:,}èª")
            
        except Exception as e:
            print(f"âš ï¸  ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            import traceback
            traceback.print_exc()
        
        print("\\nâœ… è§£æå®Œäº†")
        print("ğŸ¯ SudachiDict-fullã«ã‚ˆã‚‹é«˜ç²¾åº¦å°‚é–€ç”¨èªè§£æãŒå®Œäº†ã—ã¾ã—ãŸ")
        EOF
    
    - name: Cleanup and optimize storage
      if: always()
      run: |
        echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œä¸­..."
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        rm -rf /tmp/*.pdf /tmp/*.docx /tmp/*.pptx /tmp/*.txt
        
        # pip ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆå®¹é‡ç¯€ç´„ï¼‰
        pip cache purge
        
        # modelsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä¿æŒï¼ˆæ¬¡å›å®Ÿè¡Œæ™‚ã®å†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å›é¿ï¼‰
        echo "ğŸ’¾ LLMãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿æŒï¼ˆå†åˆ©ç”¨ã®ãŸã‚ï¼‰"
        
        # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèª
        echo "ğŸ’½ ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡:"
        df -h | head -2
        
        echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
    
    - name: Upload comprehensive logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: mhlw-crawler-logs-${{ github.run_id }}
        path: |
          *.log
          /tmp/crawler_*.txt
          /tmp/sudachi_*.log
          /var/log/syslog
        retention-days: 14
        if-no-files-found: ignore
