# .github/workflows/crawler.yml
name: MHLW term seek with GiNZA and Stanza NLP Pipeline

on:
  workflow_dispatch:

jobs:
  discover:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.10' }

      - name: Install dependencies for Discoverer
        run: |
          pip install requests beautifulsoup4 supabase configparser url-normalize

      - name: Run URL Discoverer
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python discover_urls.py

  process_ginza:
    needs: discover
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
#        instance: [1, 2, 3, 4, 5, 6, 7, 8]
        instance: [1]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.10' }
      - name: Install GiNZA and dependencies
        run: |
          pip install -U ginza ja_ginza_electra
          pip install requests beautifulsoup4 supabase configparser
      - name: Find Installed GiNZA Model Path
        id: find_model
        run: |
          MODEL_PATH=$(python -c "import ja_ginza_electra, os; print(os.path.dirname(ja_ginza_electra.__file__))")
          echo "Found GiNZA model at: ${MODEL_PATH}"
          echo "model_path=${MODEL_PATH}" >> $GITHUB_OUTPUT
      - name: Run GiNZA Processor (Instance ${{ matrix.instance }})
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GINZA_MODEL_PATH: ${{ steps.find_model.outputs.model_path }}
        run: python process_ginza.py

  process_stanza:
    needs: discover
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
#        instance: [1, 2, 3, 4, 5, 6, 7, 8]
        instance: [1]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.10' }
      - name: Install Stanza and dependencies
        run: |
          pip install "numpy<2.0" stanza
          pip install requests beautifulsoup4 supabase configparser
      - name: Pre-download Stanza model
        run: |
          python -c "import stanza; stanza.download('ja', verbose=False)"
      - name: Run Stanza Processor (Instance ${{ matrix.instance }})
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python process_stanza.py
